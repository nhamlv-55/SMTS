#!/bin/bash


if [[ $# -lt 3 ]]; then
    echo "Usage: $0 <packed-script-dir> <output-dir> <single_shell-script1> [<single-shell-script2> [ ... ] ]";
    exit 1;
fi

packedscrd=$1; shift
outd=`readlink -e $1`; shift



i=0
# How many processes to run in the node
ncpus=6
# Timeout (this is probably in CPU time so if you run multithreaded,
# mutiply the number by the number of threads)
#timeout=1000
# --mem=30000 30GB

while [[ $# > 0 ]]; do
    ex=$1;
    bname=`basename $ex`
    scrname=`printf "%s" 'bash-'${bname}`
    echo $scrname
    cat << _EOF_ > $packedscrd/$scrname
#!/bin/bash
## Generated by $0
## From $ex
#SBATCH --time=24:00:00
#SBATCH --exclusive
#SBATCH --nodes=1
#SBATCH --mem=0
#SBATCH --partition=slim
#SBATCH --output=$outd/$scrname.out
#SBATCH --error=$outd/$scrname.err

output=$outd/$scrname

_EOF_

    for ((i=0; i < $ncpus; i++)); do
        if [[ $# == 0 ]]; then
            break;
        fi
        ex=$1; shift
        cat << _EOF_ >> $packedscrd/$scrname
 (
  echo $ex;
  sh $ex;
 ) > \$output.${i}.out 2> \$output.${i}.err &
_EOF_
    done
    echo "wait" >> $packedscrd/$scrname
#    echo $packedscrd
#    echo $scrname
    i=$((i+1))
    chmod +x $packedscrd/$scrname
done